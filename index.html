<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lưu tọa độ vào Google Sheets — bản tối ưu</title>
  <style>
    :root { --fg:#111; --muted:#666; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 640px; margin: 24px auto; padding: 0 16px; color: var(--fg); }
    h2 { margin: 0 0 12px; }
    .row { display: flex; gap: 8px; }
    input, button, select { padding: 10px 12px; font-size: 16px; }
    input { flex: 1; }
    button { cursor: pointer; }
    #status { margin-top: 14px; white-space: pre-line; }
    .muted { color: var(--muted); font-size: 14px; }
    .ok { color: #0a7a0a; }
    .err { color: #b00020; }
    .map { margin-top: 12px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; height: 260px; display:none; }
    .tip { background: #f7f7f7; padding: 8px 10px; border-radius: 8px; margin-top: 10px; }
    .row-2 { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
  </style>
</head>
<body>
  <h2>Lưu tọa độ bạn đã ghé</h2>
  <div class="row">
    <input id="placeName" type="text" placeholder="Nhập tên địa điểm" />
    <button id="saveBtn">Lưu vào Google Sheets</button>
  </div>

  <div class="row-2" style="margin-top:8px;">
    <input id="note" type="text" placeholder="Ghi chú (tuỳ chọn)" />
    <select id="accuracy">
      <option value="true">Ưu tiên độ chính xác</option>
      <option value="false" selected>Ưu tiên tốc độ</option>
    </select>
  </div>

  <p class="muted">Lưu ý: Geolocation chỉ hoạt động trên trang <b>https://</b> hoặc localhost. Nếu bị chặn, bạn có thể gõ toạ độ thủ công ở hộp bên dưới.</p>

  <details class="tip">
    <summary>Nhập toạ độ thủ công (trong trường hợp GPS không hoạt động)</summary>
    <div class="row" style="margin-top:8px;">
      <input id="latManual" inputmode="decimal" placeholder="Vĩ độ (VD: 10.762622)" />
      <input id="lonManual" inputmode="decimal" placeholder="Kinh độ (VD: 106.660172)" />
      <button id="useManual">Dùng</button>
    </div>
  </details>

  <h3>Kết quả:</h3>
  <div id="status"></div>
  <div id="geoHelp" class="tip" style="display:none">
    <b>Truy cập vị trí đang bị chặn.</b>
    <p id="geoSteps" class="muted" style="margin:6px 0 10px"></p>
    <div class="row">
      <button id="retryGPS">Thử lại yêu cầu GPS</button>
      <button id="openSiteSettings" title="Mở hướng dẫn bật quyền">Hướng dẫn bật quyền</button>
    </div>
  </div>
  <iframe id="map" class="map" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>

  <script>
  // 👉 DÁN URL Web App của Apps Script vào đây:
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw49kScp3TgL8Q_-fcsjowKy5piudn1mYvkPwmE4buHSJs76wHX_ltE_xjpHPTAPAE2/exec"; // URL web app
  const TOKEN = "abc123"; // tuỳ chọn, để '' nếu không dùng

  const btn = document.getElementById("saveBtn");
  const statusEl = document.getElementById("status");
  const mapEl = document.getElementById("map");

  const geoHelpEl = document.getElementById("geoHelp");
  const geoStepsEl = document.getElementById("geoSteps");
  const retryBtn = document.getElementById("retryGPS");
  const openSiteBtn = document.getElementById("openSiteSettings");

  const placeInput = document.getElementById("placeName");
  const noteInput = document.getElementById("note");
  const accuracySel = document.getElementById("accuracy");

  const latManual = document.getElementById("latManual");
  const lonManual = document.getElementById("lonManual");
  const useManualBtn = document.getElementById("useManual");

  function setStatus(text, cls = "") {
    statusEl.className = cls;
    statusEl.innerText = text;
  }
  function linkToMaps(lat, lon) {
    return `https://www.google.com/maps?q=${lat},${lon}`;
  }
  function setMap(lat, lon) {
    mapEl.style.display = "block";
    mapEl.src = `https://maps.google.com/maps?q=${lat},${lon}&z=15&output=embed`;
  }

  function getPosition(options = {}) {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject(new Error("Trình duyệt không hỗ trợ GPS."));
        return;
      }
      navigator.geolocation.getCurrentPosition(resolve, reject, options);
    });
  }

  function detectBrowser() {
    const ua = navigator.userAgent.toLowerCase();
    const isIOS = /iphone|ipad|ipod/.test(ua);
    if (ua.includes("edg/")) return "edge";
    if (ua.includes("chrome") && !ua.includes("edg/") && !ua.includes("opr/"))
      return isIOS ? "ios-chrome" : "chrome";
    if (ua.includes("safari") && !ua.includes("chrome"))
      return isIOS ? "ios-safari" : "safari";
    if (ua.includes("firefox")) return "firefox";
    return "other";
  }

  function showGeoHelp() {
    const b = detectBrowser();
    let steps = "";
    switch (b) {
      case "chrome":
      case "edge":
        steps =
          "Nhấn vào biểu tượng ổ khoá trên thanh địa chỉ → Quyền → Vị trí → Cho phép. Sau đó tải lại trang.";
        break;
      case "firefox":
        steps =
          "Nhấn vào biểu tượng khiên/ổ khoá → Quyền → Vị trí → Cho phép cho trang này. Rồi tải lại trang.";
        break;
      case "safari":
        steps =
          "Safari → Preferences → Websites → Location → chọn Allow cho trang này. Sau đó reload.";
        break;
      case "ios-safari":
        steps =
          "Cài đặt iOS → Safari → Vị trí → Cho phép. Hoặc vào Cài đặt → Quyền riêng tư → Dịch vụ định vị → bật cho Safari.";
        break;
      case "ios-chrome":
        steps =
          "Cài đặt iOS → Chrome → Vị trí → Cho phép khi dùng ứng dụng. Sau đó mở lại trang.";
        break;
      default:
        steps =
          "Mở cài đặt quyền của trình duyệt và bật Quyền vị trí (Location) cho trang này, rồi tải lại.";
    }
    geoStepsEl.textContent = steps;
    geoHelpEl.style.display = "block";
  }

  function hideGeoHelp() {
    geoHelpEl.style.display = "none";
  }

  async function saveLocationWith(lat, lon) {
    const name = placeInput.value.trim();
    if (!name) {
      alert("Hãy nhập tên địa điểm!");
      return;
    }

    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = "Đang lưu...";

    try {
      const time = new Date().toISOString();
      const ua = navigator.userAgent;
      const note = noteInput.value.trim();

      setStatus("📤 Đang gửi lên Google Sheets...");

      const form = new URLSearchParams({ name, lat, lon, time, ua, note });
      if (TOKEN) form.append("token", TOKEN);

      const resp = await fetch(SCRIPT_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
        },
        body: form.toString(),
      });

      const text = await resp.text();
      let msg = "";
      try {
        const data = JSON.parse(text);
        if (data && data.ok) {
          msg = `✅ Đã lưu: ${name}\nTọa độ: ${lat}, ${lon}\nDòng: ${
            data.row ?? "?"
          }`;
        } else {
          msg = `⚠️ Đã gửi nhưng phản hồi không như mong đợi.\nServer: ${text.slice(
            0,
            200
          )}`;
        }
      } catch {
        if (resp.ok)
          msg = `✅ Đã lưu (server trả text).\nServer: ${text.slice(0, 200)}`;
        else msg = `❌ Lỗi HTTP ${resp.status}.\nServer: ${text.slice(0, 200)}`;
      }

      msg += `\n🔗 Xem trên Maps: ${linkToMaps(lat, lon)}`;
      setStatus(msg, resp.ok ? "ok" : "err");
      setMap(lat, lon);
    } catch (err) {
      setStatus("❌ Lỗi: " + (err?.message || String(err)), "err");
    } finally {
      btn.disabled = false;
      btn.textContent = originalText;
    }
  }

  async function saveLocation() {
    const latMan = latManual.value.trim();
    const lonMan = lonManual.value.trim();
    if (latMan && lonMan)
      return saveLocationWith(Number(latMan), Number(lonMan));

    setStatus("⏳ Đang lấy tọa độ...");
    const enableHighAccuracy = accuracySel.value === "true";

    try {
      const pos = await getPosition({
        enableHighAccuracy,
        timeout: 10000,
        maximumAge: enableHighAccuracy ? 1000 : 30000,
      });

      const lat = Number(pos.coords.latitude.toFixed(6));
      const lon = Number(pos.coords.longitude.toFixed(6));
      setStatus("📍 Lấy tọa độ xong.");
      await saveLocationWith(lat, lon);
    } catch (err) {
      const msg = err?.message || String(err);
      setStatus("❌ Không lấy được tọa độ tự động: " + msg, "err");
      if (err && (err.code === 1 || /denied|permission|blocked/i.test(msg))) {
        showGeoHelp();
      }
    }
  }

  async function retryGeolocationOnce() {
    setStatus("⏳ Thử xin quyền vị trí lại...");
    try {
      const pos = await getPosition({
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 1000,
      });
      hideGeoHelp();
      const lat = Number(pos.coords.latitude.toFixed(6));
      const lon = Number(pos.coords.longitude.toFixed(6));
      setStatus("📍 Đã lấy được tọa độ sau khi cấp quyền.");
      await saveLocationWith(lat, lon);
    } catch (err) {
      setStatus(
        "❌ Vẫn chưa có quyền vị trí: " + (err?.message || err),
        "err"
      );
      showGeoHelp();
    }
  }

  btn.addEventListener("click", saveLocation);
  retryBtn.addEventListener("click", retryGeolocationOnce);
  openSiteBtn.addEventListener("click", showGeoHelp);
  useManualBtn.addEventListener("click", () => {
    if (!latManual.value || !lonManual.value) {
      alert("Nhập đủ vĩ độ & kinh độ");
      return;
    }
    saveLocationWith(Number(latManual.value), Number(lonManual.value));
  });
</script>

</body>
</html>


