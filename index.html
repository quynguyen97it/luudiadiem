<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LÆ°u tá»a Ä‘á»™ vÃ o Google Sheets â€” báº£n tá»‘i Æ°u</title>
  <style>
    :root { --fg:#111; --muted:#666; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 640px; margin: 24px auto; padding: 0 16px; color: var(--fg); }
    h2 { margin: 0 0 12px; }
    .row { display: flex; gap: 8px; }
    input, button, select { padding: 10px 12px; font-size: 16px; }
    input { flex: 1; }
    button { cursor: pointer; }
    #status { margin-top: 14px; white-space: pre-line; }
    .muted { color: var(--muted); font-size: 14px; }
    .ok { color: #0a7a0a; }
    .err { color: #b00020; }
    .map { margin-top: 12px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; height: 260px; display:none; }
    .tip { background: #f7f7f7; padding: 8px 10px; border-radius: 8px; margin-top: 10px; }
    .row-2 { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
  </style>
</head>
<body>
  <h2>LÆ°u tá»a Ä‘á»™ báº¡n Ä‘Ã£ ghÃ©</h2>
  <div class="row">
    <input id="placeName" type="text" placeholder="Nháº­p tÃªn Ä‘á»‹a Ä‘iá»ƒm" />
    <button id="saveBtn">LÆ°u vÃ o Google Sheets</button>
  </div>

  <div class="row-2" style="margin-top:8px;">
    <input id="note" type="text" placeholder="Ghi chÃº (tuá»³ chá»n)" />
    <select id="accuracy">
      <option value="true">Æ¯u tiÃªn Ä‘á»™ chÃ­nh xÃ¡c</option>
      <option value="false" selected>Æ¯u tiÃªn tá»‘c Ä‘á»™</option>
    </select>
  </div>

  <p class="muted">LÆ°u Ã½: Geolocation chá»‰ hoáº¡t Ä‘á»™ng trÃªn trang <b>https://</b> hoáº·c localhost. Náº¿u bá»‹ cháº·n, báº¡n cÃ³ thá»ƒ gÃµ toáº¡ Ä‘á»™ thá»§ cÃ´ng á»Ÿ há»™p bÃªn dÆ°á»›i.</p>

  <details class="tip">
    <summary>Nháº­p toáº¡ Ä‘á»™ thá»§ cÃ´ng (trong trÆ°á»ng há»£p GPS khÃ´ng hoáº¡t Ä‘á»™ng)</summary>
    <div class="row" style="margin-top:8px;">
      <input id="latManual" inputmode="decimal" placeholder="VÄ© Ä‘á»™ (VD: 10.762622)" />
      <input id="lonManual" inputmode="decimal" placeholder="Kinh Ä‘á»™ (VD: 106.660172)" />
      <button id="useManual">DÃ¹ng</button>
    </div>
  </details>

  <h3>Káº¿t quáº£:</h3>
  <div id="status"></div>
  <div id="geoHelp" class="tip" style="display:none">
    <b>Truy cáº­p vá»‹ trÃ­ Ä‘ang bá»‹ cháº·n.</b>
    <p id="geoSteps" class="muted" style="margin:6px 0 10px"></p>
    <div class="row">
      <button id="retryGPS">Thá»­ láº¡i yÃªu cáº§u GPS</button>
      <button id="openSiteSettings" title="Má»Ÿ hÆ°á»›ng dáº«n báº­t quyá»n">HÆ°á»›ng dáº«n báº­t quyá»n</button>
    </div>
  </div>
  <iframe id="map" class="map" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>

  <script>
  // ğŸ‘‰ DÃN URL Web App cá»§a Apps Script vÃ o Ä‘Ã¢y:
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw49kScp3TgL8Q_-fcsjowKy5piudn1mYvkPwmE4buHSJs76wHX_ltE_xjpHPTAPAE2/exec"; // URL web app
  const TOKEN = "abc123"; // tuá»³ chá»n, Ä‘á»ƒ '' náº¿u khÃ´ng dÃ¹ng

  const btn = document.getElementById("saveBtn");
  const statusEl = document.getElementById("status");
  const mapEl = document.getElementById("map");

  const geoHelpEl = document.getElementById("geoHelp");
  const geoStepsEl = document.getElementById("geoSteps");
  const retryBtn = document.getElementById("retryGPS");
  const openSiteBtn = document.getElementById("openSiteSettings");

  const placeInput = document.getElementById("placeName");
  const noteInput = document.getElementById("note");
  const accuracySel = document.getElementById("accuracy");

  const latManual = document.getElementById("latManual");
  const lonManual = document.getElementById("lonManual");
  const useManualBtn = document.getElementById("useManual");

  function setStatus(text, cls = "") {
    statusEl.className = cls;
    statusEl.innerText = text;
  }
  function linkToMaps(lat, lon) {
    return `https://www.google.com/maps?q=${lat},${lon}`;
  }
  function setMap(lat, lon) {
    mapEl.style.display = "block";
    mapEl.src = `https://maps.google.com/maps?q=${lat},${lon}&z=15&output=embed`;
  }

  function getPosition(options = {}) {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject(new Error("TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ GPS."));
        return;
      }
      navigator.geolocation.getCurrentPosition(resolve, reject, options);
    });
  }

  function detectBrowser() {
    const ua = navigator.userAgent.toLowerCase();
    const isIOS = /iphone|ipad|ipod/.test(ua);
    if (ua.includes("edg/")) return "edge";
    if (ua.includes("chrome") && !ua.includes("edg/") && !ua.includes("opr/"))
      return isIOS ? "ios-chrome" : "chrome";
    if (ua.includes("safari") && !ua.includes("chrome"))
      return isIOS ? "ios-safari" : "safari";
    if (ua.includes("firefox")) return "firefox";
    return "other";
  }

  function showGeoHelp() {
    const b = detectBrowser();
    let steps = "";
    switch (b) {
      case "chrome":
      case "edge":
        steps =
          "Nháº¥n vÃ o biá»ƒu tÆ°á»£ng á»• khoÃ¡ trÃªn thanh Ä‘á»‹a chá»‰ â†’ Quyá»n â†’ Vá»‹ trÃ­ â†’ Cho phÃ©p. Sau Ä‘Ã³ táº£i láº¡i trang.";
        break;
      case "firefox":
        steps =
          "Nháº¥n vÃ o biá»ƒu tÆ°á»£ng khiÃªn/á»• khoÃ¡ â†’ Quyá»n â†’ Vá»‹ trÃ­ â†’ Cho phÃ©p cho trang nÃ y. Rá»“i táº£i láº¡i trang.";
        break;
      case "safari":
        steps =
          "Safari â†’ Preferences â†’ Websites â†’ Location â†’ chá»n Allow cho trang nÃ y. Sau Ä‘Ã³ reload.";
        break;
      case "ios-safari":
        steps =
          "CÃ i Ä‘áº·t iOS â†’ Safari â†’ Vá»‹ trÃ­ â†’ Cho phÃ©p. Hoáº·c vÃ o CÃ i Ä‘áº·t â†’ Quyá»n riÃªng tÆ° â†’ Dá»‹ch vá»¥ Ä‘á»‹nh vá»‹ â†’ báº­t cho Safari.";
        break;
      case "ios-chrome":
        steps =
          "CÃ i Ä‘áº·t iOS â†’ Chrome â†’ Vá»‹ trÃ­ â†’ Cho phÃ©p khi dÃ¹ng á»©ng dá»¥ng. Sau Ä‘Ã³ má»Ÿ láº¡i trang.";
        break;
      default:
        steps =
          "Má»Ÿ cÃ i Ä‘áº·t quyá»n cá»§a trÃ¬nh duyá»‡t vÃ  báº­t Quyá»n vá»‹ trÃ­ (Location) cho trang nÃ y, rá»“i táº£i láº¡i.";
    }
    geoStepsEl.textContent = steps;
    geoHelpEl.style.display = "block";
  }

  function hideGeoHelp() {
    geoHelpEl.style.display = "none";
  }

  async function saveLocationWith(lat, lon) {
    const name = placeInput.value.trim();
    if (!name) {
      alert("HÃ£y nháº­p tÃªn Ä‘á»‹a Ä‘iá»ƒm!");
      return;
    }

    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = "Äang lÆ°u...";

    try {
      const time = new Date().toISOString();
      const ua = navigator.userAgent;
      const note = noteInput.value.trim();

      setStatus("ğŸ“¤ Äang gá»­i lÃªn Google Sheets...");

      const form = new URLSearchParams({ name, lat, lon, time, ua, note });
      if (TOKEN) form.append("token", TOKEN);

      const resp = await fetch(SCRIPT_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
        },
        body: form.toString(),
      });

      const text = await resp.text();
      let msg = "";
      try {
        const data = JSON.parse(text);
        if (data && data.ok) {
          msg = `âœ… ÄÃ£ lÆ°u: ${name}\nTá»a Ä‘á»™: ${lat}, ${lon}\nDÃ²ng: ${
            data.row ?? "?"
          }`;
        } else {
          msg = `âš ï¸ ÄÃ£ gá»­i nhÆ°ng pháº£n há»“i khÃ´ng nhÆ° mong Ä‘á»£i.\nServer: ${text.slice(
            0,
            200
          )}`;
        }
      } catch {
        if (resp.ok)
          msg = `âœ… ÄÃ£ lÆ°u (server tráº£ text).\nServer: ${text.slice(0, 200)}`;
        else msg = `âŒ Lá»—i HTTP ${resp.status}.\nServer: ${text.slice(0, 200)}`;
      }

      msg += `\nğŸ”— Xem trÃªn Maps: ${linkToMaps(lat, lon)}`;
      setStatus(msg, resp.ok ? "ok" : "err");
      setMap(lat, lon);
    } catch (err) {
      setStatus("âŒ Lá»—i: " + (err?.message || String(err)), "err");
    } finally {
      btn.disabled = false;
      btn.textContent = originalText;
    }
  }

  async function saveLocation() {
    const latMan = latManual.value.trim();
    const lonMan = lonManual.value.trim();
    if (latMan && lonMan)
      return saveLocationWith(Number(latMan), Number(lonMan));

    setStatus("â³ Äang láº¥y tá»a Ä‘á»™...");
    const enableHighAccuracy = accuracySel.value === "true";

    try {
      const pos = await getPosition({
        enableHighAccuracy,
        timeout: 10000,
        maximumAge: enableHighAccuracy ? 1000 : 30000,
      });

      const lat = Number(pos.coords.latitude.toFixed(6));
      const lon = Number(pos.coords.longitude.toFixed(6));
      setStatus("ğŸ“ Láº¥y tá»a Ä‘á»™ xong.");
      await saveLocationWith(lat, lon);
    } catch (err) {
      const msg = err?.message || String(err);
      setStatus("âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c tá»a Ä‘á»™ tá»± Ä‘á»™ng: " + msg, "err");
      if (err && (err.code === 1 || /denied|permission|blocked/i.test(msg))) {
        showGeoHelp();
      }
    }
  }

  async function retryGeolocationOnce() {
    setStatus("â³ Thá»­ xin quyá»n vá»‹ trÃ­ láº¡i...");
    try {
      const pos = await getPosition({
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 1000,
      });
      hideGeoHelp();
      const lat = Number(pos.coords.latitude.toFixed(6));
      const lon = Number(pos.coords.longitude.toFixed(6));
      setStatus("ğŸ“ ÄÃ£ láº¥y Ä‘Æ°á»£c tá»a Ä‘á»™ sau khi cáº¥p quyá»n.");
      await saveLocationWith(lat, lon);
    } catch (err) {
      setStatus(
        "âŒ Váº«n chÆ°a cÃ³ quyá»n vá»‹ trÃ­: " + (err?.message || err),
        "err"
      );
      showGeoHelp();
    }
  }

  btn.addEventListener("click", saveLocation);
  retryBtn.addEventListener("click", retryGeolocationOnce);
  openSiteBtn.addEventListener("click", showGeoHelp);
  useManualBtn.addEventListener("click", () => {
    if (!latManual.value || !lonManual.value) {
      alert("Nháº­p Ä‘á»§ vÄ© Ä‘á»™ & kinh Ä‘á»™");
      return;
    }
    saveLocationWith(Number(latManual.value), Number(lonManual.value));
  });
</script>

</body>
</html>


